<?php

namespace SSNepenthe\Soter\Tasks;

use WP_Query;
use SSNepenthe\Soter\Register_Vulnerability_Post_Type;

if ( ! defined( 'ABSPATH' ) ) {
	die;
}

class Vulnerability_Garbage_Collection {
	/**
	 * Piggybacks on the daily wp_scheduled_delete task to delete "expired" posts of
	 * type "soter_vulnerability".
	 */
	public function init() {
		add_action(
			'wp_scheduled_delete',
			[ $this, 'delete_expired_vulnerabilities' ]
		);
	}

	/**
	 * "Expired" may not be the best descriptor here... Basically, we know that
	 * any vulnerability which affects the site in its current state cannot have
	 * been created more than 12 hours ago since that is how often the scan is run.
	 */
	public function delete_expired_vulnerabilities() {
		$query = new WP_Query( [
			'date_query' => [
				'before' => '1 minute ago',
			],
			'fields' => 'ids',
			'no_found_rows' => true,
			'post_type' => Register_Vulnerability_Post_Type::POST_TYPE,
			'post_status' => Register_Vulnerability_Post_Type::POST_STATUS,
			'posts_per_page' => Register_Vulnerability_Post_Type::POSTS_PER_PAGE,
			'update_post_meta_cache' => false,
			'update_post_term_cache' => false,
		] );

		// Can be empty.
		foreach ( $query->posts as $id ) {
			wp_delete_post( $id );
		}
	}
}
